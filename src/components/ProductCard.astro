---
// src/components/ProductCard.astro
// ============================================
// üçï CMDOLA - Carte Produit avec DaisyUI
// ============================================

import ProductModal from './ProductModal.astro';
import "../assets/app.css";

interface Props {
  id: string;
  nom: string;
  description?: string;
  prix: number;
  category?: string;
  image?: string;
  images?: string[];
  disponible?: boolean;
  popular?: boolean;
  supplements?: string[];
  allergenes?: string[];
  removable_ingredients?: string[];
}

const {
  id,
  nom,
  description = '',
  prix,
  category = '',
  image,
  images = [],
  disponible = true,
  popular = false,
  supplements = [],
  allergenes = [],
  removable_ingredients = [],
} = Astro.props;

// Image par d√©faut si non fournie
const defaultImage = 'https://img.daisyui.com/images/stock/photo-1606107557195-0e29a4b5b4aa.webp';
const productImage = image || defaultImage;

// Toutes les images (avec fallback)
const allImages = images.length > 0 ? images : (image ? [image] : [defaultImage]);

// Formatter le prix
const formatPrice = (price: number) => {
  return new Intl.NumberFormat('fr-BE', {
    style: 'currency',
    currency: 'EUR',
  }).format(price);
};
---

<div 
  class={`
    card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200
    ${!disponible ? 'opacity-60' : ''}
  `}
  data-product-id={id}
  data-product-name={nom}
  data-product-description={description}
  data-product-price={prix}
  data-product-images={JSON.stringify(allImages)}
  data-product-supplements={JSON.stringify(supplements)}
  data-product-removableingredients={JSON.stringify(removable_ingredients)}
  data-product-allergenes={JSON.stringify(allergenes)}
  data-category={category}
>
  <!-- Image avec badges -->
  <figure class="relative">
    <img
      src={productImage}
      alt={nom}
      class="w-full h-48 object-cover"
      loading="lazy"
    />
    
    <!-- Badge Populaire -->
    {popular && (
      <div class="badge badge-secondary absolute top-2 left-2">
        ‚≠ê Populaire
      </div>
    )}
    
    <!-- Badge Indisponible -->
    {!disponible && (
      <div class="badge badge-error absolute top-2 right-2">
        Victime de son succ√®s
      </div>
    )}
  </figure>

  <!-- Corps de la carte -->
  <div class="card-body">
    
    <!-- Titre et Prix -->
    <div class="flex items-start justify-between gap-2">
      <h2 class="card-title text-base flex-1">
        {nom}
      </h2>
      <span class="text-lg font-bold text-primary whitespace-nowrap">
        {formatPrice(prix)}
      </span>
    </div>

    <!-- Description -->
    {description && (
      <p class="text-sm text-base-content/70 line-clamp-2">
        {description}
      </p>
    )}

    <!-- Cat√©gorie (optionnel) -->
    {category && (
      <div class="badge badge-ghost badge-sm">
        {category}
      </div>
    )}

    <!-- Actions -->
    <div class="card-actions justify-end mt-2">
      {disponible ? (
        <button 
          class="btn btn-primary btn-sm btn-block"
          onclick={`openProductModal('${id}')`}
        >
          Voir d√©tails & Ajouter
        </button>
      ) : (
        <button class="btn btn-disabled btn-sm btn-block" disabled>
          Victime de son succ√®s
        </button>
      )}
    </div>
  </div>
</div>

<!-- Modal pour ce produit -->
<ProductModal id={id} />

<style>
  /* Truncate text sur 2 lignes */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Animation au hover */
  .card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
  }

  /* Image cover parfait */
  figure img {
    aspect-ratio: 4/3;
  }

  /* Responsive image height */
  @media (max-width: 640px) {
    figure img {
      height: 200px;
    }
  }
</style>