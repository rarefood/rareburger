---
// src/pages/admin/commandes/edit.astro
import AdminLayout from '../../../layouts/AdminLayout.astro';

export const prerender = false;

// V√©rification auth c√¥t√© serveur
const user = Astro.locals.user;
if (!user || !user.roles.includes('admin')) {
  return Astro.redirect('/login');
}

const commandeId = Astro.url.searchParams.get('id');

if (!commandeId) {
  return Astro.redirect('/admin/commandes');
}
---

<AdminLayout title="Modifier commande">
  
  <div class="mb-6">
    <div class="flex items-center gap-4">
      <a href="/admin/commandes" class="btn btn-ghost btn-sm">
        ‚Üê Retour
      </a>
      <div>
        <h1 class="text-3xl font-bold">Modifier la commande</h1>
        <p class="text-base-content/60" id="commandeNumero">Chargement...</p>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="flex justify-center py-20">
    <span class="loading loading-spinner loading-lg"></span>
  </div>

  <!-- Erreur -->
  <div id="errorState" class="hidden">
    <div class="alert alert-error">
      <span>Commande introuvable</span>
    </div>
  </div>

  <!-- Formulaire -->
  <div id="editForm" class="hidden">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Colonne principale -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Informations client -->
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Informations client</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="form-control">
                <label class="label">
                  <span class="label-text">Nom</span>
                </label>
                <input type="text" id="clientNom" class="input input-bordered" />
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text">Pr√©nom</span>
                </label>
                <input type="text" id="clientPrenom" class="input input-bordered" />
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text">Email</span>
                </label>
                <input type="email" id="clientEmail" class="input input-bordered" />
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text">T√©l√©phone</span>
                </label>
                <input type="tel" id="clientTelephone" class="input input-bordered" />
              </div>
            </div>

            <!-- Adresse (si livraison) -->
            <div id="adresseSection" class="hidden">
              <div class="divider">Adresse de livraison</div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-control md:col-span-2">
                  <label class="label">
                    <span class="label-text">Rue</span>
                  </label>
                  <input type="text" id="adresseRue" class="input input-bordered" />
                </div>

                <div class="form-control">
                  <label class="label">
                    <span class="label-text">Num√©ro</span>
                  </label>
                  <input type="text" id="adresseNumero" class="input input-bordered" />
                </div>

                <div class="form-control">
                  <label class="label">
                    <span class="label-text">Code postal</span>
                  </label>
                  <input type="text" id="adresseCodePostal" class="input input-bordered" />
                </div>

                <div class="form-control md:col-span-2">
                  <label class="label">
                    <span class="label-text">Ville</span>
                  </label>
                  <input type="text" id="adresseVille" class="input input-bordered" />
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Articles -->
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Articles command√©s</h2>
            
            <div class="overflow-x-auto">
              <table class="table table-zebra">
                <thead>
                  <tr>
                    <th>Produit</th>
                    <th>Quantit√©</th>
                    <th>Prix unitaire</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="articlesTable">
                </tbody>
              </table>
            </div>

            <div class="flex justify-end mt-4">
              <div class="text-right">
                <div class="text-sm text-base-content/60">Sous-total: <span id="sousTotal" class="font-bold">0 ‚Ç¨</span></div>
                <div class="text-sm text-base-content/60" id="fraisLivraisonRow">Frais de livraison: <span id="fraisLivraison" class="font-bold">0 ‚Ç¨</span></div>
                <div class="text-lg font-bold">Total: <span id="prixTotal">0 ‚Ç¨</span></div>
              </div>
            </div>

          </div>
        </div>

        <!-- Notes -->
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Notes / Instructions</h2>
            <textarea id="notes" class="textarea textarea-bordered h-24" placeholder="Instructions sp√©ciales..."></textarea>
          </div>
        </div>

      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        
        <!-- Statut -->
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Statut</h2>
            
            <div class="form-control">
              <select id="statut" class="select select-bordered">
                <option value="nouvelle">Nouvelle</option>
                <option value="en_preparation">En pr√©paration</option>
                <option value="prete">Pr√™te</option>
                <option value="en_livraison">En livraison</option>
                <option value="livree">Livr√©e</option>
                <option value="terminee">Termin√©e</option>
                <option value="annulee">Annul√©e</option>
              </select>
            </div>

            <div class="divider"></div>

            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-base-content/60">Type:</span>
                <span id="typeCommande" class="font-bold">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-base-content/60">Date cr√©ation:</span>
                <span id="dateCreation" class="font-bold">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-base-content/60">Num√©ro:</span>
                <span id="numeroCommande" class="font-mono font-bold">-</span>
              </div>
            </div>

          </div>
        </div>

        <!-- Paiement -->
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Paiement</h2>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">Mode</span>
              </label>
              <select id="paiementMode" class="select select-bordered select-sm">
                <option value="reception">√Ä la r√©ception</option>
                <option value="comptoir">Au comptoir</option>
                <option value="en_ligne">En ligne</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Statut</span>
              </label>
              <select id="paiementStatut" class="select select-bordered select-sm">
                <option value="a_reception">√Ä la r√©ception</option>
                <option value="en_attente">En attente</option>
                <option value="paye">Pay√©</option>
              </select>
            </div>

          </div>
        </div>

        <!-- Actions -->
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body">
            <button class="btn btn-primary btn-block" id="saveBtn">
              <span id="saveBtnText">Enregistrer</span>
              <span id="saveBtnLoader" class="loading loading-spinner loading-sm hidden"></span>
            </button>
            
            <button class="btn btn-ghost btn-block" id="printBtn">
              Imprimer le ticket
            </button>

            <div class="divider"></div>

            <button class="btn btn-error btn-outline btn-block" id="deleteBtn">
              Supprimer la commande
            </button>
          </div>
        </div>

      </div>

    </div>

  </div>

</AdminLayout>

<script>
// ==========================================
// üöÄ Imports
// ==========================================
import { api } from '../../../lib/api';

// ==========================================
// Variables Globales
// ==========================================
const urlParams = new URLSearchParams(window.location.search);
const commandeId = urlParams.get('id');

let commande = null;

// ==========================================
// Utilitaires
// ==========================================
function formatPrice(price) {
  return new Intl.NumberFormat('fr-BE', {
    style: 'currency',
    currency: 'EUR'
  }).format(price);
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return new Intl.DateTimeFormat('fr-BE', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(date);
}

// ==========================================
// Chargement Config & Th√®me
// ==========================================
async function loadConfig() {
  try {
    const config = await api.config.get();
    
    if (config.theme?.daisy) {
      document.documentElement.setAttribute('data-theme', config.theme.daisy);
    }
    
    if (config.theme?.logo) {
      const logoUrl = api.images.getUrl(config.theme.logo);
      const favicon = document.getElementById('favicon');
      if (favicon) favicon.href = logoUrl;
    }
  } catch (error) {
    console.error('‚ùå Erreur config:', error);
  }
}

// ==========================================
// Chargement Commande
// ==========================================
async function loadCommande() {
  try {
    console.log('üîÑ Chargement commande:', commandeId);
    
    // ‚úÖ Utilise api.commandes.get() (avec token auto)
    commande = await api.commandes.get(commandeId);
    
    console.log('‚úÖ Commande charg√©e:', commande);
    
    populateForm();

    document.getElementById('loader').classList.add('hidden');
    document.getElementById('editForm').classList.remove('hidden');

  } catch (error) {
    console.error('‚ùå Erreur chargement:', error);
    
    // Gestion erreur auth
    if (error.message.includes('Token') || error.message.includes('401')) {
      alert('Session expir√©e, veuillez vous reconnecter');
      window.location.href = '/login';
      return;
    }
    
    document.getElementById('loader').classList.add('hidden');
    document.getElementById('errorState').classList.remove('hidden');
  }
}

// ==========================================
// Remplissage Formulaire
// ==========================================
function populateForm() {
  document.getElementById('commandeNumero').textContent = `Commande ${commande.numero}`;
  document.getElementById('numeroCommande').textContent = commande.numero;
  document.getElementById('dateCreation').textContent = formatDate(commande.date_creation);
  document.getElementById('typeCommande').textContent = commande.type || 'N/A';

  document.getElementById('clientNom').value = commande.client?.nom || '';
  document.getElementById('clientPrenom').value = commande.client?.prenom || '';
  document.getElementById('clientEmail').value = commande.client?.email || '';
  document.getElementById('clientTelephone').value = commande.client?.telephone || '';

  if (commande.type === 'livraison' && commande.client?.adresse) {
    document.getElementById('adresseSection').classList.remove('hidden');
    document.getElementById('adresseRue').value = commande.client.adresse.rue || '';
    document.getElementById('adresseNumero').value = commande.client.adresse.numero || '';
    document.getElementById('adresseCodePostal').value = commande.client.adresse.code_postal || '';
    document.getElementById('adresseVille').value = commande.client.adresse.ville || '';
  }

  const articlesTable = document.getElementById('articlesTable');
  articlesTable.innerHTML = commande.articles.map(article => `
    <tr>
      <td>
        <div class="font-bold">${article.nom}</div>
        ${article.supplements?.length ? `<div class="text-xs text-base-content/60">+ ${article.supplements.map(s => s.name).join(', ')}</div>` : ''}
      </td>
      <td>${article.quantite}</td>
      <td>${formatPrice(article.prix)}</td>
      <td class="font-bold">${formatPrice(article.prix * article.quantite)}</td>
    </tr>
  `).join('');

  document.getElementById('sousTotal').textContent = formatPrice(commande.sous_total || 0);
  
  if (commande.frais_livraison && commande.frais_livraison > 0) {
    document.getElementById('fraisLivraisonRow').classList.remove('hidden');
    document.getElementById('fraisLivraison').textContent = formatPrice(commande.frais_livraison);
  } else {
    document.getElementById('fraisLivraisonRow').classList.add('hidden');
  }

  document.getElementById('prixTotal').textContent = formatPrice(commande.prix_total);

  document.getElementById('statut').value = commande.statut;
  document.getElementById('notes').value = commande.notes || '';
  
  document.getElementById('paiementMode').value = commande.paiement?.mode || 'reception';
  document.getElementById('paiementStatut').value = commande.paiement?.statut || 'a_reception';
}

// ==========================================
// Sauvegarde Commande
// ==========================================
async function saveCommande() {
  const saveBtn = document.getElementById('saveBtn');
  const saveBtnText = document.getElementById('saveBtnText');
  const saveBtnLoader = document.getElementById('saveBtnLoader');

  saveBtn.disabled = true;
  saveBtnText.classList.add('hidden');
  saveBtnLoader.classList.remove('hidden');

  const updatedCommande = {
    ...commande,
    client: {
      ...commande.client,
      nom: document.getElementById('clientNom').value,
      prenom: document.getElementById('clientPrenom').value,
      email: document.getElementById('clientEmail').value,
      telephone: document.getElementById('clientTelephone').value,
    },
    statut: document.getElementById('statut').value,
    notes: document.getElementById('notes').value,
    paiement: {
      mode: document.getElementById('paiementMode').value,
      statut: document.getElementById('paiementStatut').value
    }
  };

  if (commande.type === 'livraison') {
    updatedCommande.client.adresse = {
      rue: document.getElementById('adresseRue').value,
      numero: document.getElementById('adresseNumero').value,
      code_postal: document.getElementById('adresseCodePostal').value,
      ville: document.getElementById('adresseVille').value
    };
  }

  try {
    console.log('üíæ Sauvegarde commande...');
    
    // ‚úÖ Utilise api.commandes.update()
    await api.commandes.update(commandeId, updatedCommande);
    
    console.log('‚úÖ Commande mise √† jour');
    
    alert('Commande mise √† jour avec succ√®s');
    window.location.href = '/admin/commandes';
    
  } catch (error) {
    console.error('‚ùå Erreur sauvegarde:', error);
    
    // Gestion erreur auth
    if (error.message.includes('Token') || error.message.includes('401')) {
      alert('Session expir√©e, veuillez vous reconnecter');
      window.location.href = '/login';
    } else {
      alert('Erreur lors de la mise √† jour');
    }
  } finally {
    saveBtn.disabled = false;
    saveBtnText.classList.remove('hidden');
    saveBtnLoader.classList.add('hidden');
  }
}

// ==========================================
// Suppression Commande
// ==========================================
async function deleteCommande() {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette commande ?')) return;

  try {
    console.log('üóëÔ∏è Suppression commande...');
    
    // ‚úÖ Utilise api.commandes.delete()
    await api.commandes.delete(commandeId);
    
    console.log('‚úÖ Commande supprim√©e');
    
    alert('Commande supprim√©e');
    window.location.href = '/admin/commandes';
    
  } catch (error) {
    console.error('‚ùå Erreur suppression:', error);
    
    // Gestion erreur auth
    if (error.message.includes('Token') || error.message.includes('401')) {
      alert('Session expir√©e, veuillez vous reconnecter');
      window.location.href = '/login';
    } else {
      alert('Erreur lors de la suppression');
    }
  }
}

// ==========================================
// Impression (endpoint non existant pour l'instant)
// ==========================================
async function printCommande() {
  alert('Fonctionnalit√© d\'impression √† impl√©menter');
  // TODO: Cr√©er l'endpoint /api/commandes/{id}/print dans Flask
}

// ==========================================
// Event Listeners
// ==========================================
document.getElementById('saveBtn').addEventListener('click', saveCommande);
document.getElementById('deleteBtn').addEventListener('click', deleteCommande);
document.getElementById('printBtn').addEventListener('click', printCommande);

// ==========================================
// Initialisation
// ==========================================
console.log('‚úèÔ∏è Page d\'√©dition commande charg√©e');

loadConfig();
loadCommande();
</script>